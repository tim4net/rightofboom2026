{#
  Safe Sweep Results Aggregator

  Input: CTX.review_results - array of endpoint results
  Output: Aggregated structure for AI narrative generation
#}

{#- First pass: collect all failed tests with their hosts -#}
{%- set all_failures = [] -%}
{%- set scores = [] -%}
{%- set grades = [] -%}

{%- for result in CTX.review_results | default([]) -%}
  {%- set _ = scores.append(result.summary.score | default(0)) -%}
  {%- set _ = grades.append(result.summary.grade | default('F')) -%}

  {%- for test in result.tests | default([]) -%}
    {%- if test.status in ['fail', 'warn', 'FAIL', 'WARN'] -%}
      {%- set _ = all_failures.append({
        'test_id': test.id | string,
        'test_name': test.name | default('Unknown Test'),
        'category': test.category | default('General'),
        'severity': test.status | lower,
        'mitre_id': test.mitre_id | default(''),
        'remediation': test.remediation | default({}),
        'hostname': result.metadata.hostname | default('Unknown')
      }) -%}
    {%- endif -%}
  {%- endfor -%}
{%- endfor -%}

{#- Calculate summary stats -#}
{%- set endpoint_count = CTX.review_results | default([]) | length -%}
{%- set avg_score = (scores | sum / endpoint_count) | round(1) if endpoint_count > 0 else 0 -%}

{#- Count grades -#}
{%- set grade_a = grades | select('equalto', 'A') | list | length -%}
{%- set grade_b = grades | select('equalto', 'B') | list | length -%}
{%- set grade_c = grades | select('equalto', 'C') | list | length -%}
{%- set grade_d = grades | select('equalto', 'D') | list | length -%}
{%- set grade_f = grades | select('equalto', 'F') | list | length -%}

{#- Determine overall grade -#}
{%- if avg_score >= 90 -%}
  {%- set overall_grade = 'A' -%}
{%- elif avg_score >= 80 -%}
  {%- set overall_grade = 'B' -%}
{%- elif avg_score >= 70 -%}
  {%- set overall_grade = 'C' -%}
{%- elif avg_score >= 60 -%}
  {%- set overall_grade = 'D' -%}
{%- else -%}
  {%- set overall_grade = 'F' -%}
{%- endif -%}

{#- Group failures by test_id -#}
{%- set unique_test_ids = all_failures | map(attribute='test_id') | unique | list -%}
{%- set aggregated_findings = [] -%}

{%- for tid in unique_test_ids -%}
  {%- set matching = all_failures | selectattr('test_id', 'equalto', tid) | list -%}
  {%- set first = matching | first -%}
  {%- set hosts = matching | map(attribute='hostname') | list -%}
  {%- set host_display = hosts[:10] -%}

  {%- set _ = aggregated_findings.append({
    'test_id': tid,
    'test_name': first.test_name,
    'category': first.category,
    'severity': 'fail' if (matching | selectattr('severity', 'equalto', 'fail') | list | length > 0) else 'warn',
    'mitre_id': first.mitre_id,
    'remediation': first.remediation,
    'failed_count': matching | length,
    'endpoint_count': endpoint_count,
    'affected_hosts': host_display
  }) -%}
{%- endfor -%}

{#- Sort by failed_count descending -#}
{%- set sorted_findings = aggregated_findings | sort(attribute='failed_count', reverse=true) -%}

{#- Output -#}
{{
  {
    'org_name': CTX.org_name | default('Organization'),
    'endpoint_count': endpoint_count,
    'summary': {
      'average_score': avg_score,
      'overall_grade': overall_grade,
      'endpoints_by_grade': {'A': grade_a, 'B': grade_b, 'C': grade_c, 'D': grade_d, 'F': grade_f},
      'total_findings': sorted_findings | length
    },
    'aggregated_findings': sorted_findings
  }
}}
